{% extends 'posts/base.html' %}

{% block title %}{{ target.username }} - Instagram Direct{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column;">
    <!-- Chat Header -->
    <div style="background: white; border-bottom: 1px solid #dbdbdb; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
            {% if target.profile_image %}
                <img src="{{ target.profile_image.url }}" alt="{{ target.username }}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
            {% else %}
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #0095f6, #ed4956); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">{{ target.username|slice:":1"|upper }}</div>
            {% endif %}
            <div>
                <div style="font-weight: 600; color: #262626;">{{ target.username }}</div>
            </div>
        </div>
        <a href="{% url 'profile' target.user_uuid %}" style="background: #f0f0f0; border: none; padding: 0.6rem 1rem; border-radius: 24px; text-decoration: none; color: #262626; font-weight: 600; font-size: 0.85rem;">Profil</a>
    </div>

    <!-- Messages -->
    <div id="messages" style="flex: 1; overflow-y: auto; padding: 1rem; background: white; display: flex; flex-direction: column; gap: 0.75rem;">
        <div style="text-align: center; color: #999; padding: 2rem;">Učitavanje poruka...</div>
    </div>

    <!-- Input -->
    <div style="background: white; border-top: 1px solid #dbdbdb; padding: 1rem; display: flex; gap: 0.75rem; align-items: flex-end;">
        <textarea id="message-input" placeholder="Aa" style="flex: 1; border: 1px solid #dbdbdb; border-radius: 24px; padding: 0.75rem 1rem; resize: none; min-height: 36px; max-height: 100px; font-family: inherit; font-size: 0.9rem;"></textarea>
        <button id="send-btn" style="background: #0095f6; color: white; border: none; padding: 0.6rem 1.5rem; border-radius: 24px; font-weight: 600; cursor: pointer;">Pošalji</button>
    </div>
</div>

<script>
(function(){
  const messagesEl = document.getElementById('messages');
  const input = document.getElementById('message-input');
  const send = document.getElementById('send-btn');
  const targetUuid = '{{ target.user_uuid }}';
  let lastMessageId = 0;

  function formatTime(dateString) {
    try {
      const date = new Date(dateString);
      if(isNaN(date.getTime())) return 'invalid date';
      return date.toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });
    } catch(e) {
      return 'invalid date';
    }
  }

  function appendMessage(id, text, fromMe, timestamp) {
    // Don't add duplicate messages
    if(document.querySelector(`[data-msg-id="${id}"]`)) return;
    
    const el = document.createElement('div');
    el.setAttribute('data-msg-id', id);
    el.style.cssText = `
      display: flex;
      justify-content: ${fromMe ? 'flex-end' : 'flex-start'};
      margin-bottom: 0.5rem;
    `;
    
    const bubble = document.createElement('div');
    bubble.style.cssText = `
      background: ${fromMe ? '#0095f6' : '#e5e5ea'};
      color: ${fromMe ? 'white' : '#262626'};
      padding: 0.75rem 1rem;
      border-radius: 18px;
      max-width: 70%;
      word-wrap: break-word;
      font-size: 0.9rem;
    `;
    bubble.textContent = text;
    
    el.appendChild(bubble);
    messagesEl.appendChild(el);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    
    lastMessageId = Math.max(lastMessageId, id);
  }

  function loadMessages() {
    fetch(`/chat/${targetUuid}/get/`, { credentials: 'same-origin' })
      .then(r => r.json())
      .then(data => {
        if(data.messages.length === 0 && lastMessageId === 0) {
          messagesEl.innerHTML = '<div style="text-align: center; color: #999; padding: 2rem;">Započni razgovor...</div>';
        } else if(data.messages.length > 0) {
          // Only add new messages
          data.messages.forEach(msg => {
            if(msg.id > lastMessageId) {
              appendMessage(msg.id, msg.content, msg.is_from_me, msg.created_at);
            }
          });
          
          // If first load and messages exist, render all
          if(lastMessageId === 0) {
            messagesEl.innerHTML = '';
            data.messages.forEach(msg => {
              appendMessage(msg.id, msg.content, msg.is_from_me, msg.created_at);
            });
          }
        }
      })
      .catch(err => {
        if(lastMessageId === 0) {
          messagesEl.innerHTML = '<div style="text-align: center; color: #999; padding: 2rem;">⚠️ Greška pri učitavanju</div>';
        }
        console.error(err);
      });
  }

  function sendMessage() {
    const txt = input.value.trim();
    if(!txt) return;

    const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]');
    const headers = {
      'X-CSRFToken': csrf ? csrf.value : '',
      'Content-Type': 'application/json'
    };

    const body = JSON.stringify({ content: txt });

    send.disabled = true;
    send.textContent = '...';

    fetch(`/chat/${targetUuid}/send/`, { 
      method: 'POST', 
      headers, 
      body,
      credentials: 'same-origin' 
    })
      .then(r => r.json())
      .then(data => {
        if(data.success) {
          appendMessage(data.id, data.content, true, data.created_at);
          input.value = '';
          loadMessages();
        } else {
          alert('Greška: ' + (data.error || 'Nije moguće poslati poruku'));
        }
      })
      .catch(err => {
        alert('Greška pri slanju poruke');
        console.error(err);
      })
      .finally(() => {
        send.disabled = false;
        send.textContent = 'Pošalji';
      });
  }

  send.addEventListener('click', sendMessage);
  
  input.addEventListener('keypress', function(e) {
    if(e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  loadMessages();
  setInterval(loadMessages, 2000);
})();
</script>

{% endblock %}