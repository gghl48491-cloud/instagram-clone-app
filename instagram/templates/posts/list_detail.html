{% extends 'posts/base.html' %}

{% block title %}{{ post.title }} - Instagram{% endblock %}

{% block content %}
<div class="container" style="max-width: 600px; margin-top: 2rem;">
    <div style="background: white; border: 1px solid #dbdbdb; border-radius: 3px; margin-bottom: 2rem;">
        <!-- Post Header -->
        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border-bottom: 1px solid #efefef;">
            {% if post.author.profile_image %}
                <img src="{{ post.author.profile_image.url }}" alt="{{ post.author.username }}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
            {% else %}
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #0095f6, #ed4956); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85rem;">{{ post.author.username|slice:":1"|upper }}</div>
            {% endif %}
            <div style="flex: 1;">
                <div style="font-weight: 600; color: #262626;"><a href="{% url 'profile' post.author.user_uuid %}" style="text-decoration: none; color: #262626;">{{ post.author.username }}</a></div>
                <small style="color: #999;">{{ post.created_at|date:"d.m.Y H:i" }}</small>
            </div>
        </div>

        <!-- Post Image -->
        {% if post.post_image %}
            <img src="{{ post.post_image.url }}" alt="{{ post.title }}" style="width: 100%; height: auto; max-height: 600px; object-fit: cover;">
        {% else %}
            <div style="width: 100%; height: 300px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); display: flex; align-items: center; justify-content: center; font-size: 3rem;">ğŸ“</div>
        {% endif %}

        <!-- Post Actions -->
        <div style="display: flex; gap: 1rem; padding: 0.75rem 1rem; border-bottom: 1px solid #efefef;">
            <button id="like-button" onclick="toggleLike()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">{% if user_liked %}â¤ï¸{% else %}ğŸ¤{% endif %}</button>
            <button id="dislike-button" onclick="toggleDislike()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">ğŸ‘</button>
            <button style="background: none; border: none; font-size: 1.5rem; cursor: pointer; margin-left: auto;">ğŸ“¤</button>
        </div>

        <!-- Stats -->
        <div style="padding: 0.5rem 1rem; font-weight: 600; color: #262626; border-bottom: 1px solid #efefef;">
            <span id="likes-count">{{ likes_count|default:0 }}</span> sviÄ‘anja
        </div>

        <!-- Post Description -->
        <div style="padding: 1rem;">
            <div style="margin-bottom: 0.5rem;">
                <strong><a href="{% url 'profile' post.author.user_uuid %}" style="text-decoration: none; color: #262626;">{{ post.author.username }}</a></strong>
                <span style="color: #262626;">{{ post.title }}</span>
            </div>
            {% if post.content %}
                <div style="color: #262626; margin-bottom: 0.5rem;">{{ post.content }}</div>
            {% endif %}
            <div style="color: #999; font-size: 0.85rem;">{{ post.created_at|timesince }} ago</div>
        </div>

        <!-- Comments Section -->
        <div style="border-top: 1px solid #efefef; padding: 1rem;">
            <div id="comments-list" style="margin-bottom: 1rem; max-height: 300px; overflow-y: auto;">
                <div style="text-align: center; color: #999; padding: 1rem;">UÄitavanje komentara...</div>
            </div>

            {% if request.user.is_authenticated %}
                <form id="comment-form" method="post" action="{% url 'add_comment' post.uuid_field %}" style="display: flex; gap: 0.5rem;">
                    {% csrf_token %}
                    <textarea name="content" id="comment-content" placeholder="Dodaj komentar..." style="flex: 1; border: 1px solid #dbdbdb; border-radius: 24px; padding: 0.75rem 1rem; resize: none; min-height: 36px; max-height: 80px; font-size: 0.9rem; font-family: inherit;"></textarea>
                    <button type="submit" style="background: none; border: none; color: #0095f6; font-weight: 600; cursor: pointer; padding: 0 0.75rem;">Objavi</button>
                </form>
            {% else %}
                <div style="text-align: center; padding: 1rem; background: #f9f9f9; border-radius: 3px; color: #999;">
                    Prijavite se da dodate komentar.
                </div>
            {% endif %}
        </div>

        <!-- Edit/Delete for owner -->
        {% if request.user == post.author %}
            <div style="display: flex; gap: 0.5rem; padding: 1rem; border-top: 1px solid #efefef;">
                <a href="{% url 'update' post.uuid_field %}" style="flex: 1; text-align: center; background: #0095f6; color: white; padding: 0.75rem 1rem; border-radius: 24px; text-decoration: none; font-weight: 600;">Uredi</a>
                <button id="delete-btn" onclick="if(confirm('Obrisati post?')) { document.getElementById('delete-form').submit(); }" style="flex: 1; background: #ed4956; color: white; border: none; padding: 0.75rem 1rem; border-radius: 24px; font-weight: 600; cursor: pointer;">ObriÅ¡i</button>
            </div>
            <form id="delete-form" method="post" action="{% url 'delete' post.uuid_field %}" style="display: none;">
                {% csrf_token %}
            </form>
        {% endif %}
    </div>
</div>

<script>
const postLikeUrl = '/{{ post.uuid_field }}/like';
const postDislikeUrl = '/{{ post.uuid_field }}/dislike';
const likeButton = document.getElementById('like-button');
const dislikeButton = document.getElementById('dislike-button');
const likesCountEl = document.getElementById('likes-count');
const commentForm = document.getElementById('comment-form');
const commentInput = document.getElementById('comment-content');

function toggleLike() {
    fetch(postLikeUrl, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } })
    .then(r => r.json())
    .then(d => {
        likeButton.textContent = d.liked ? 'â¤ï¸' : 'ğŸ¤';
        likesCountEl.textContent = d.likes;
    });
}

function toggleDislike() {
    fetch(postDislikeUrl, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } })
    .then(r => r.json())
    .then(d => {
        dislikeButton.textContent = d.disliked ? 'ğŸ‘' : 'ğŸ‘';
        likesCountEl.textContent = d.likes;
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function loadComments() {
    fetch('/{{ post.uuid_field }}/comment/get')
    .then(r => r.json())
    .then(data => {
        const list = document.getElementById('comments-list');
        const comments = data.comments || [];
        if (!comments || comments.length === 0) {
            list.innerHTML = '<div style="text-align: center; color: #999;">Nema komentara</div>';
            return;
        }
        list.innerHTML = '';
        comments.forEach(c => {
            const div = document.createElement('div');
            div.style.marginBottom = '0.75rem';
            div.innerHTML = `
                <div style="display: flex; gap: 0.5rem;">
                    <strong><a href="/users/${c.author_uuid}/" style="text-decoration: none; color: #262626;">${c.author}</a></strong>
                    <span style="color: #262626;">${c.content}</span>
                </div>
                <div style="color: #999; font-size: 0.75rem;">${c.created_at}</div>
            `;
            list.appendChild(div);
        });
    })
    .catch(err => console.error('Error loading comments:', err));
}

commentForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const content = commentInput.value.trim();
    if (!content) return;
    
    const formData = new FormData(commentForm);
    fetch('{% url "add_comment" post.uuid_field %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(r => r.json())
    .then(data => {
        commentInput.value = '';
        loadComments();
    })
    .catch(err => console.error('Error adding comment:', err));
});

loadComments();
setInterval(loadComments, 2000);
</script>
{% endblock %}
