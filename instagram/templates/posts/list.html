{% extends 'posts/base.html' %}

{% block title %}PoÄetna - Instagram{% endblock %}

{% block header %}PoÄetna{% endblock %}

{% block content %}
<div class="container">
    {% for post in page_obj %}
    <div class="post-card">
        <!-- Post Header -->
        <div class="post-header">
            {% if post.author.profile_image %}
                <img src="{{ post.author.profile_image.url }}" alt="{{ post.author.username }}" class="post-header-avatar">
            {% else %}
                <div class="post-header-avatar" style="background: linear-gradient(135deg, #0095f6, #ed4956); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.1rem;">{{ post.author.username|slice:":1"|upper }}</div>
            {% endif %}
            <div class="post-header-info">
                <h3><a href="{% url 'profile' post.author.user_uuid %}" style="text-decoration: none; color: #262626;">{{ post.author.username }}</a></h3>
                <small>{{ post.created_at|date:"d.m.Y H:i" }}</small>
            </div>
        </div>

        <!-- Post Image -->
        {% if post.post_image %}
            <div class="post-image-wrapper">
                <img src="{{ post.post_image.url }}" alt="{{ post.title }}" style="width: 100%; height: 300px; object-fit: cover;">
            </div>
        {% else %}
            <div style="width: 100%; height: 300px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); display: flex; align-items: center; justify-content: center; font-size: 2rem;">ğŸ“</div>
        {% endif %}

        <!-- Post Content -->
        <div class="post-content">
            <!-- Post Actions -->
            <div class="post-actions">
                <button class="post-action-btn" onclick="togglePostLike(this, '{{ post.uuid_field }}')">â¤ï¸</button>
                <button class="post-action-btn" onclick="location.href='/{{ post.uuid_field }}/#comments'">ğŸ’¬</button>
                <button class="post-action-btn">ğŸ“¤</button>
            </div>

            <!-- Stats -->
            <div class="post-stats" id="likes-{{ post.uuid_field }}">0 sviÄ‘anja</div>

            <!-- Description -->
            <div class="post-description">
                <strong><a href="{% url 'profile' post.author.user_uuid %}" style="text-decoration: none; color: #262626;">{{ post.author.username }}</a></strong>
                {{ post.title }}
                {% if post.content %}
                    <br><span style="color: #999;">{{ post.content|truncatewords:30 }}</span>
                {% endif %}
            </div>

            <!-- Timestamp -->
            <div class="post-timestamp">{{ post.created_at|timesince }} ago</div>

            <!-- Edit/Delete for owner -->
            {% if request.user == post.author %}
                <div style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid #efefef; display: flex; gap: 0.75rem;">
                    <a href="{{ post.uuid_field }}/update" style="flex: 1; padding: 0.5rem; text-align: center; background: #0095f6; color: white; text-decoration: none; border-radius: 24px; font-size: 0.85rem; font-weight: 600;">Uredi</a>
                    <a href="{{ post.uuid_field }}/delete" style="flex: 1; padding: 0.5rem; text-align: center; background: #ed4956; color: white; text-decoration: none; border-radius: 24px; font-size: 0.85rem; font-weight: 600;">ObriÅ¡i</a>
                </div>
            {% endif %}

            <!-- View Full Post -->
            <a href="{{ post.uuid_field }}" style="display: block; margin-top: 0.75rem; padding: 0.5rem; text-align: center; background: #efefef; color: #262626; text-decoration: none; border-radius: 3px; font-size: 0.9rem; font-weight: 600;">Pogledaj sve komentare</a>
        </div>
    </div>
    {% endfor %}

    <!-- Pagination -->
    <div style="margin: 3rem auto; text-align: center; max-width: 400px;">
        {% if page_obj.has_previous %}
            <a href="?page=1" class="btn-primary" style="display: inline-block; margin: 0.5rem;">Â« Prva</a>
            <a href="?page={{ page_obj.previous_page_number }}" class="btn-primary" style="display: inline-block; margin: 0.5rem;">Prethodna</a>
        {% endif %}

        <span style="display: inline-block; padding: 0.5rem 1rem; color: #999;">
            Stranica {{ page_obj.number }} od {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="btn-primary" style="display: inline-block; margin: 0.5rem;">SljedeÄ‡a</a>
            <a href="?page={{ page_obj.paginator.num_pages }}" class="btn-primary" style="display: inline-block; margin: 0.5rem;">Zadnja Â»</a>
        {% endif %}
    </div>
</div>

<script>
function togglePostLike(btn, postId) {
    fetch(`/${postId}/like`, {method: 'POST', headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''}})
        .then(r => r.json())
        .then(d => {
            btn.innerHTML = d.liked ? 'â¤ï¸' : 'ğŸ¤';
            document.getElementById(`likes-${postId}`).innerHTML = `${d.likes_count} sviÄ‘anja`;
        });
}
</script>
{% endblock %}